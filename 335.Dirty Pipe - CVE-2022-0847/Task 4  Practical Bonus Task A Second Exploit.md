**Overview**

In the previous task, we exploited the Dirty Pipe vulnerability using Max Kellerman's original proof of concept exploit code; however, other exploits have since been released. The original PoC allowed us to overwrite any file with arbitrary data at an offset of our choosing; however, other implementations have abused the arbitrary file write vulnerability in a variety of different ways.

To demonstrate this concept, a second exploit script has been added to the lab machine — this can be found on the target at `/home/tryhackme/Exploit/Bl4sty/dirtypipez.c`. As the directory structure suggests, this implementation was coded by [@bl4sty](https://twitter.com/bl4sty/), a security researcher who you may remember if you have already completed the "[SudoVulns: Baron Samedit](https://tryhackme.com/room/sudovulnssamedit)" room. The original exploit code can be downloaded from bl4sty's website [here](https://haxx.in/files/dirtypipez.c); however, as mentioned previously, a copy has already been added to the lab machine.

This exploit takes the arbitrary file write one stage further by abusing a rather special quality of the vulnerability. SUID Programs usually lose their [SUID bit](https://muirlandoracle.co.uk/2020/03/05/unix-file-permissions/#SUID) when you attempt to write to them; however, this does not happen with Dirty Pipe — in other words, we can write to any program that has permission to execute with higher privileges, without inadvertently destroying that extra permission (as would usually happen).

Bl4sty's exploit capitalises on this. Instead of overwriting a file like `/etc/passwd`, it overwrites a user-specified SUID binary (such as `/bin/su`), injecting shellcode into it which then gets executed with the permissions of the privileged user (i.e. `root`). Specifically, the exploit hijacks the chosen SUID binary and forces it to create a backdoor binary in  `/tmp` which has the SUID bit and calls `/bin/sh`. It then restores the targeted SUID binary to full working order by re-adding the overwritten section, and uses the newly created backdoor to grant the attacker a shell as the privileged user.

  

**Exploitation**

Before continuing with this task, please ensure that you have exited your session as the root user. You should once again be executing commands in the context of the `tryhackme` user.

As the `tryhackme` user, compile the exploit using the same syntax as was given in the previous task, e.g.:

Compilation Command

```shell-session
tryhackme@dirty-pipe:~/Exploit/Bl4sty$ gcc dirtypipez.c -o exploit
tryhackme@dirty-pipe:~/Exploit/Bl4sty$ ls
dirtypipez.c  exploit
```

With the exploit compiled, it should be run with a single argument specifying a target binary, owned by root and with the SUID bit set, for example: `./exploit /bin/su`.

You should now once again have a root shell!  

Answer the questions below

Exploit the target using bl4sty's exploit for Dirty Pipe  

Correct Answer

Make sure to clean up after yourself!

Remove the SUID binary created by the script (`/tmp/sh`).  

Correct Answer

**[Optional]** Find another exploit for this vulnerability online. Review the code to ensure that it does what it claims to do, then upload it to the target and attempt to exploit the vulnerability a third way.